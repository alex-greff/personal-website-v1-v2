sudo: required
services:
    - docker
env:
    global:
        - SHA=$(git rev-parse HEAD)
branches:
    only:
    - master
    - staging
before_install:
    - openssl aes-256-cbc -K $encrypted_14a560c41847_key -iv $encrypted_14a560c41847_iv -in travis_rsa.enc -out travis_rsa -d
    - docker build -t alexgreff/personal-website-client-test -f ./client/Dockerfile.dev ./client
script:
    - docker run alexgreff/personal-website-client-test npm run test:coverage
after_success:
    - docker build -t alexgreff/personal-website-client:latest -t alexgreff/personal-website-client:$SHA -f ./client/Dockerfile ./client
    - docker build -t alexgreff/personal-website-server:latest -t alexgreff/personal-website-server:$SHA -f ./server/Dockerfile ./server
    - docker build -t alexgreff/personal-website-nginx:latest -t alexgreff/personal-website-nginx:$SHA -f ./nginx/Dockerfile ./nginx
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
    - docker push alexgreff/personal-website-client:latest
    - docker push alexgreff/personal-website-server:latest
    - docker push alexgreff/personal-website-nginx:latest
    - docker push alexgreff/personal-website-client:$SHA
    - docker push alexgreff/personal-website-server:$SHA
    - docker push alexgreff/personal-website-nginx:$SHA
deploy:
    provider: script
    script: bash ./deploy.sh
    on:
        branch: master